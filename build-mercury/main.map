{"version":3,"sources":["webpack:///webpack/bootstrap f6c417c6bf45ad714929","webpack:///./mercury/queues/constants.js","webpack:///external \"debug\"","webpack:///./mercury/index.js","webpack:///./mercury/queues/processReputationEvent.js","webpack:///./shared/bull/create-worker.js","webpack:///external \"http\"","webpack:///./shared/bull/create-queue.js","webpack:///external \"bull\"","webpack:///external \"raven\""],"names":["PROCESS_REPUTATION_EVENT","THREAD_CREATED","debug","require","createWorker","PORT","process","env","console","log","server","COMPOSE_REDIS_URL","COMPOSE_REDIS_PORT","listen","address","port","job","type","userId","entityId","data","id","Promise","resolve","http","createQueue","sumArr","input","prop","reduce","sum","item","queueMap","queues","Object","keys","map","name","queue","createServer","req","res","setHeader","all","getJobCounts","then","jobCounts","waiting","active","completed","failed","delayed","end","JSON","stringify","module","exports","Queue","Raven","config","environment","NODE_ENV","install","redis","host","password","COMPOSE_REDIS_PASSWORD","undefined","options","on","message","error","captureException","Error"],"mappings":";;;AAAA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAK;AACL;AACA;;AAEA;AACA;AACA;AACA,mCAA2B,0BAA0B,EAAE;AACvD,yCAAiC,eAAe;AAChD;AACA;AACA;;AAEA;AACA,8DAAsD,+DAA+D;;AAErH;AACA;;AAEA;AACA;;;;;;;;;;;;;;;AC3DA;AACO,MAAMA,8DAA2B,0BAAjC;;AAEP;AACO,MAAMC,0CAAiB,gBAAvB,C;;;;;;ACNP,kC;;;;;;;;;;;;;;;;ACIA;;;;AACA;;;;AAJA;AACA,MAAMC,QAAQ,mBAAAC,CAAQ,CAAR,EAAiB,SAAjB,CAAd;AACA,MAAMC,eAAe,mBAAAD,CAAQ,CAAR,CAArB;;;AAIA,MAAME,OAAOC,QAAQC,GAAR,CAAYF,IAAZ,IAAoB,IAAjC;;AAEAG,QAAQC,GAAR,CAAY,qDAAZ;AACAP,MAAM,6BAAN;AACAM,QAAQC,GAAR,CAAY,EAAZ;;AAEA,MAAMC,SAASN,aAAa;AAC1B;AAD0B,CAAb,CAAf;;AAIAI,QAAQC,GAAR,CACG,gCAAgC,kBAAyB,YAAzB,IAC9B,MAAKH,QAAQC,GAAR,CAAYI,iBAAkB,IAAGL,QAAQC,GAAR,CAAYK,kBAAmB,EADxC,IAE9B,SAAU,EAHd;;AAMAF,OAAOG,MAAP,CAAcR,IAAd,EAAoB,WAApB,EAAiC,MAAM;AACrCG,UAAQC,GAAR,CACG,oCAAmCC,OAAOI,OAAP,GACjCA,OAAQ,IAAGJ,OAAOI,OAAP,GAAiBC,IAAK,EAFtC;AAID,CALD,E;;;;;;;;;;;;;ACrBA;;AADA,MAAMb,QAAQ,mBAAAC,CAAQ,CAAR,EAAiB,wCAAjB,CAAd;;kBAGea,OAAO;AACpB,QAAM,EAAEC,IAAF,EAAQC,MAAR,EAAgBC,QAAhB,KAA6BH,IAAII,IAAvC;AACAlB,QAAO,cAAac,IAAIK,EAAG,EAA3B;AACAnB,QAAO,iCAAgCe,IAAK,EAA5C;AACAf,QAAO,qCAAoCiB,QAAS,EAApD;;AAGA,SAAOG,QAAQC,OAAR,EAAP;AACD,C;;;;;;;;;ACXD;AACA;AACA,MAAMC,OAAO,mBAAArB,CAAQ,CAAR,CAAb;AACA,MAAMsB,cAAc,mBAAAtB,CAAQ,CAAR,CAApB;;AAEA;;;;;;AAMA;AACA;AACA,MAAMuB,SAAS,CACbC,KADa,CACP;AADO,EAEbC,IAFa,CAER,aAFQ,CAEM;AAFN,KAGV;AACH,SAAOD,MAAME,MAAN,CAAa,CAACC,GAAD,EAAMC,IAAN,KAAeD,MAAMC,KAAKH,IAAL,CAAlC,EAA8C,CAA9C,CAAP;AACD,CALD;;AAOA,MAAMxB,eAAe,CAAC4B,QAAD,CAAU,eAAV,KAA8B;AACjD;AACA,QAAMC,SAASC,OAAOC,IAAP,CAAYH,QAAZ,EAAsBI,GAAtB,CAA0BC,QAAQ;AAC/C,UAAMC,QAAQb,YAAYY,IAAZ,CAAd;AACAC,UAAMhC,OAAN,CAAc0B,SAASK,IAAT,CAAd;AACA,WAAOC,KAAP;AACD,GAJc,CAAf;;AAMA,SAAOd,KAAKe,YAAL,CAAkB,CAACC,GAAD,EAAMC,GAAN,KAAc;AACrCA,QAAIC,SAAJ,CAAc,cAAd,EAA8B,kBAA9B;AACA;AACApB,YAAQqB,GAAR,CAAYV,OAAOG,GAAP,CAAWE,SAASA,MAAMM,YAAN,EAApB,CAAZ,EAAuDC,IAAvD,CAA4DC,aAAa;AACvE,YAAM1B,OAAO;AACX2B,iBAASrB,OAAOoB,SAAP,EAAkB,SAAlB,CADE;AAEXE,gBAAQtB,OAAOoB,SAAP,EAAkB,QAAlB,CAFG;AAGXG,mBAAWvB,OAAOoB,SAAP,EAAkB,WAAlB,CAHA;AAIXI,gBAAQxB,OAAOoB,SAAP,EAAkB,QAAlB,CAJG;AAKXK,iBAASzB,OAAOoB,SAAP,EAAkB,SAAlB;AALE,OAAb;;AAQAL,UAAIW,GAAJ,CAAQC,KAAKC,SAAL,CAAelC,IAAf,EAAqB,IAArB,EAA2B,CAA3B,CAAR;AACD,KAVD;AAWD,GAdM,CAAP;AAeD,CAvBD;;AAyBAmC,OAAOC,OAAP,GAAiBpD,YAAjB,C;;;;;;AC9CA,iC;;;;;;;;;ACCA,MAAMqD,QAAQ,mBAAAtD,CAAQ,CAAR,CAAd;AACA,MAAMuD,QAAQ,mBAAAvD,CAAQ,CAAR,CAAd;;AAEA,IAAI,KAAJ,EAA4C;AAC1CuD,QAAMC,MAAN,CACE,4FADF,EAEE;AACEC,iBAAatD,QAAQC,GAAR,CAAYsD;AAD3B,GAFF,EAKEC,OALF;AAMD;;AAED,MAAMC,QACJ,SACI;AACEhD,QAAMT,QAAQC,GAAR,CAAYK,kBADpB;AAEEoD,QAAM1D,QAAQC,GAAR,CAAYI,iBAFpB;AAGEsD,YAAU3D,QAAQC,GAAR,CAAY2D;AAHxB,CADJ,GAMIC,SAPN,C,CAOiB;;AAEjB;AACA,MAAMC,UAAUL,SAAS,EAAEA,OAAOA,KAAT,EAAzB;;AAEA,SAAStC,WAAT,CAAqBY,IAArB,CAA0B,aAA1B,EAAyC;AACvC,QAAMC,QAAQ,IAAImB,KAAJ,CAAUpB,IAAV,EAAgB+B,OAAhB,CAAd;AACA9B,QAAM+B,EAAN,CAAS,SAAT,EAAoBrD,OAAO;AACzB,UAAMsD,UAAW,OAAMtD,IAAIK,EAAG,6BAA9B;AACA,QAAI,IAAJ,EAA2C;AACzCb,cAAQ+D,KAAR,CAAcD,OAAd;AACA;AACD;AACD;AACAZ,UAAMc,gBAAN,CAAuB,IAAIC,KAAJ,CAAUH,OAAV,CAAvB;AACD,GARD;AASA,SAAO,IAAIb,KAAJ,CAAUpB,IAAV,EAAgB+B,OAAhB,CAAP;AACD;;AAEDb,OAAOC,OAAP,GAAiB/B,WAAjB,C;;;;;;ACvCA,iC;;;;;;ACAA,kC","file":"main.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 2);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap f6c417c6bf45ad714929","// @flow\n\n// queues\nexport const PROCESS_REPUTATION_EVENT = 'process reputation event'\n\n// reputation event types\nexport const THREAD_CREATED = 'thread created'\n\n\n\n// WEBPACK FOOTER //\n// ./mercury/queues/constants.js","module.exports = require(\"debug\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"debug\"\n// module id = 1\n// module chunks = 0","// @flow\n// $FlowFixMe\nconst debug = require('debug')('mercury');\nconst createWorker = require('../shared/bull/create-worker');\nimport processReputationEvent from './queues/processReputationEvent';\nimport { PROCESS_REPUTATION_EVENT } from './queues/constants'\n\nconst PORT = process.env.PORT || 3004;\n\nconsole.log('\\n✉️ Mercury, the reputation worker, is starting...');\ndebug('Logging with debug enabled!');\nconsole.log('');\n\nconst server = createWorker({\n  [PROCESS_REPUTATION_EVENT]: processReputationEvent,\n});\n\nconsole.log(\n  `🗄 Mercury open for business ${(process.env.NODE_ENV === 'production' &&\n    `at ${process.env.COMPOSE_REDIS_URL}:${process.env.COMPOSE_REDIS_PORT}`) ||\n    'locally'}`\n);\n\nserver.listen(PORT, 'localhost', () => {\n  console.log(\n    `💉 Healthcheck server running at ${server.address()\n      .address}:${server.address().port}`\n  );\n});\n\n\n\n// WEBPACK FOOTER //\n// ./mercury/index.js","// @flow\nconst debug = require('debug')('mercury:queue:process-reputation-event');\nimport { THREAD_CREATED } from './constants'\n\nexport default job => {\n  const { type, userId, entityId } = job.data;\n  debug(`\\nnew job: ${job.id}`);\n  debug(`\\nprocessing reputation type: ${type}`);\n  debug(`\\nprocessing reputation entityId: ${entityId}`);\n\n\n  return Promise.resolve()\n};\n\n\n\n// WEBPACK FOOTER //\n// ./mercury/queues/processReputationEvent.js","// @flow\r\n// Create a worker with bull and start a small webserver which responds with\r\n// health information\r\nconst http = require('http');\r\nconst createQueue = require('./create-queue');\r\n\r\n/*::\r\ntype QueueMap = {\r\n  [name: string]: (job: any) => Promise<any>\r\n}\r\n*/\r\n\r\n// Helper function to sum properties of an array of objects\r\n// e.g. [{ completed: 6 }, { completed: 2 }] => 8\r\nconst sumArr = (\r\n  input /*: Array<Object> */,\r\n  prop /*: string */ /*: number */\r\n) => {\r\n  return input.reduce((sum, item) => sum + item[prop], 0);\r\n};\r\n\r\nconst createWorker = (queueMap /*: QueueMap */) => {\r\n  // Start processing the queues\r\n  const queues = Object.keys(queueMap).map(name => {\r\n    const queue = createQueue(name);\r\n    queue.process(queueMap[name]);\r\n    return queue;\r\n  });\r\n\r\n  return http.createServer((req, res) => {\r\n    res.setHeader('Content-Type', 'application/json');\r\n    // Summarize the data across all the queues\r\n    Promise.all(queues.map(queue => queue.getJobCounts())).then(jobCounts => {\r\n      const data = {\r\n        waiting: sumArr(jobCounts, 'waiting'),\r\n        active: sumArr(jobCounts, 'active'),\r\n        completed: sumArr(jobCounts, 'completed'),\r\n        failed: sumArr(jobCounts, 'failed'),\r\n        delayed: sumArr(jobCounts, 'delayed'),\r\n      };\r\n\r\n      res.end(JSON.stringify(data, null, 2));\r\n    });\r\n  });\r\n};\r\n\r\nmodule.exports = createWorker;\r\n\n\n\n// WEBPACK FOOTER //\n// ./shared/bull/create-worker.js","module.exports = require(\"http\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"http\"\n// module id = 6\n// module chunks = 0","// @flow\r\nconst Queue = require('bull');\r\nconst Raven = require('raven');\r\n\r\nif (process.env.NODE_ENV !== 'development') {\r\n  Raven.config(\r\n    'https://3bd8523edd5d43d7998f9b85562d6924:d391ea04b0dc45b28610e7fad735b0d0@sentry.io/154812',\r\n    {\r\n      environment: process.env.NODE_ENV,\r\n    }\r\n  ).install();\r\n}\r\n\r\nconst redis =\r\n  process.env.NODE_ENV === 'production'\r\n    ? {\r\n        port: process.env.COMPOSE_REDIS_PORT,\r\n        host: process.env.COMPOSE_REDIS_URL,\r\n        password: process.env.COMPOSE_REDIS_PASSWORD,\r\n      }\r\n    : undefined; // Use the local instance of Redis in development by not passing any connection string\r\n\r\n// Leave the options undefined if we're using the default redis connection\r\nconst options = redis && { redis: redis };\r\n\r\nfunction createQueue(name /*: string */) {\r\n  const queue = new Queue(name, options);\r\n  queue.on('stalled', job => {\r\n    const message = `Job#${job.id} stalled, processing again.`;\r\n    if (process.env.NODE_ENV !== 'production') {\r\n      console.error(message);\r\n      return;\r\n    }\r\n    // In production log stalled job to Sentry\r\n    Raven.captureException(new Error(message));\r\n  });\r\n  return new Queue(name, options);\r\n}\r\n\r\nmodule.exports = createQueue;\r\n\n\n\n// WEBPACK FOOTER //\n// ./shared/bull/create-queue.js","module.exports = require(\"bull\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"bull\"\n// module id = 8\n// module chunks = 0","module.exports = require(\"raven\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"raven\"\n// module id = 9\n// module chunks = 0"],"sourceRoot":""}